## Planning the Custom Device

The most critical phase of custom device development is planning. Several idiosyncrasies of NI VeriStand require more thorough planning than does a small stand-alone LabVIEW application. There are five main things that must be planned.
1.	Channels
2.	Properties
3.	Hierarchy
4.	Pages
5.	Device Type
After you have a clear idea of the channels, properties, hierarchy, pages, and type of custom device, you're ready to start implementation. In the following discussion, we'll refer to a hypothetical 3rd party analog to digital (A/D) converter, the AES-201. A hypothetical device was chosen to simplify this discussion. If you prefer to follow along with an actual device, please refer to NI DeveloperZone Tutorial: Building Custom Devices for NI VeriStand 2010.

Figure: A Hypothetical Digitizer called the AES-201

The AES-201 has (8) 32-bit analog input channels (AI). The device can digitize on ±1V or
±500mV. The card has a single software trigger line. Each channel has a software enable that is ON by default, and a 6Hz low pass filter that is OFF by default. A call to the hardware API makes a single A/D conversion on the specified channel and returns raw data. The range of the device cannot be changed after the device has been initialized.
Channels
Channels are the built-in mechanism used to exchange data between the custom device and the rest of the NI VeriStand system. All channels are 64-bit floating point numbers; there is no built-in mechanism for other channel data types. There are three common use cases for planning a custom device channel.
1.	Data generated by the custom device after it's deployed that may be required by other parts of the NI VeriStand system.
2.	Data originating elsewhere in the NI VeriStand system that may be consumed by the custom device after it's deployed.
3.	Dynamic properties that may change after the device is deployed can be implemented in channels.

Notice the emphasis on “may”. Custom devices should be designed with a generic use-
case in mind. Just because your customer doesn’t use all channels and settings of the hardware doesn’t mean you shouldn’t expose everything to the operator.

Given these use cases, the AES-201 custom device should have one channel each for ADDataFromCh<1..8>. The digitized data is going to change while the device is running. The operator may need that data to be available to the rest of the NI VeriStand system. For example, operators often map data from hardware to simulation model inputs.
 
The operator may need the ability to map the AES-201 software trigger to another channel in the system explorer (a calculated channel for instance). So the developer should create a channel for SWTrig. The operator may need the ability to disable a channel or toggle the input filter or the AES-201 while the device is running. The developer should plan an additional 16 channels: one each for FilterEnCh<1..8> and ADEnCh<1..8>.

NI VeriStand channels are always LabVIEW DBLs. It may be easier to flatten data to DBL than it is to implement a background communication loop that passes native data types to the rest of the system. While the AES-201’s LabVIEW API calls for Boolean data to enable the channel or filter, you can still use a DBL channel with the assumption
that 0 = False and !0 = True.

Channels are created with NI VeriStand Custom Device API » Configuration » Add Custom Device Channel. The type of channel is either Input or Output. Channel type is with respect to the custom device. If the custom device passes data to the rest of the NI VeriStand system, it requires an output channel. If the custom device gets data from the rest of the system, it requires an input channel. For example, the AES-201 may have 8 output channels (ADDataFromCh<1..8>) and 17 input channels (ADEnCh<1..8>, FilterEnCh<1..8> and SWTrig).
Once the custom device is loaded into NI VeriStand, the operator can map each input channel to a single data source. Similarly, the operator can map each output channel to an arbitrary number of sinks. For example, you can map ADDataFromCh1 to several simulation model inputs, but SWTrig may be mapped to a user channel or model output, but not both.
 
NI VeriStand – Add Custom Device Channel VI Owning Palette: Configuration

Adds a channel to the device or device subsection specified by Parrent Ref in. If the Channel Name you specify already exists, the VI overwrites the existing channel settings without affecting any custom properties.

 

Highlight? makes the item active in System Explorer.
GUID (Default Channel) the GUID of a custom channel defined in the custom device XML file.
Parent Ref in is the NI VeriStand reference to the parent section for the new channel.
Channel Name is the name of the new channel. The name is applied to the channel when the VI runs. If the operator changes the name of the channel in the System Explorer, the changed name persists.
     Channel defines the type, units, and default value of the channel. It also toggles Faultable and Scalable
properties on the channel.
error in describes error conditions that occur before this node runs. This input provides standard error in
functionality.
Property names is an string array of arbitrary property names associated with the channel.
Property Values is a variant array that cooresponds one-to-one with the property names.
Parent Ref out is a duplicate of the Parent Ref in.
Channel Ref provides the NI VeriStand reference to the new channel within the custom device.
error out contains error information. This output provides standard error out functionality.



The Add Custom Device Channel VI may be called from any VI that runs on the host computer. There are several other VIs in the NI VeriStand Custom Device LabVIEW palette that operate on custom device channels. The behavior of the VI is what you’d expect given the name of the VI.
	Configuration » Get Custom Device Channel Data VI
	Configuration » Rename Custom Device Item VI
	Configuration » Remove Custom Device Item VI
	Channel Properties » Set Custom Device Channel Default Value VI
	Channel Properties » Set Custom Device Channel Faultability VI
	Channel Properties » Set Custom Device Channel Scalability VI
	Channel Properties » Set Custom Device Channel Type VI
	Channel Properties » Set Custom Device Channel Units VI
	Driver Functions » Get Custom Device Channel List VI
In addition to these channel-specific VIs, any VI from the Item Properties palette may be used with a custom device channel.
Properties
Properties are used within the custom device to communicate state information. Property names are case-sensitive strings. Unlike channels, property values may be any standard LabVIEW data type. Properties are the recommended way to transfer configuration and state
 
information from the configuration to the engine on a one-time basis. The transfer occurs when the system definition is deployed to the execution host.
After the system definition is deployed, the engine may still read and write properties on the execution host, but it may not exchange properties with the host computer using the property VIs.
The range setting on the AES-201 is best implemented as a custom device property because the range cannot be changed after the card has been initialized. The configuration routine on the host computer can set the Range property of the card based on operator input. When the operator deploys the system definition, the engine can then read the Range property. The engine can then make the appropriate call to the hardware API to set the range.
After the AES-201 has been started, the range cannot be changed. If the operator wants to change the range setting, he must launch System Explorer, reconfigure the custom device, and redeploy the system definition. The engine may still read or write the Range property, but the change is not reflected in System Explorer.
You may decide to implement the filter setting as a property. The operator would enable or disable the filter in System Explorer by toggling a check-box on each channel’s page. On one hand, the device would require 8 fewer channels. On the other hand, the operator could no longer toggle the input filter while the custom device was running. To illustrate several aspects of custom device development, we will implement the filter setting as a property.
In this small example, we have eluded to a design decision often faced by custom device developers. As the number of use-cases and flexibility of a custom device increases, so does the complexity of planning and implementing the device. The tradeoff is a more robust device that requires less customization by the operator.

NI VeriStand – Set Item Property VI Owning Palette: Item Properties VIs

Sets a Property Name and Value for an item. If the Property Name you specify already exists, NI VeriStand overwrites the property.

 

Item Ref In is the NI VeriStand reference to the item destined for the property.
Property Name is an arbitrary case-sensitive name for the property.
Value corresponds to the value of the property. This is a polymorphic VI and the data type of the value input cooresponds with the instance.
error in describes error conditions that occur before this node runs. This input provides standard error in
functionality.
Item Ref out is a duplicate of the Item Ref in.
error out contains error information. This output provides standard error out functionality.

Replaced indicates if the property was overwriten by the new value.

The Set Item Property VI may be called from any VI in the custom device. Properties can be applied to any channel or section. In addition to the Set Item Property VI, properties can be set
 
when a channel or section is created by using the Property Names and Property Values
terminals.
A property must be read from the item to which it was set. For example, if you set the Filter_Enabled property on the ADDataFromCh1 channel, you cannot read the value of the Filter_Enabled property directly from the parent section or any reference other than ADDataFromCh1. Properties do not inherit.

NI VeriStand – Get Item Property VI Owning Palette: Item Properties VIs

Returns the Value of a specific item Property Name. If the Property Name does not exist for the specified item,
Value returns Default Value.

 

Item Ref in is the NI VeriStand reference to query for the property.
Property Name is an arbitrary case-sensitive name for the property.
Default Value is returned by the Value terminal if the property is not found.
error in describes error conditions that occur before this node runs. This input provides standard error in functionality.
Item Ref out is a duplicate of Item Ref in.
value is the value of the property. This is a polymorphic VI and the data type of the Default Value and
Value terminals coorespond with the instance.
error out contains error information. This output provides standard error out functionality.

Found indicates if Property Name was found on Item Ref in (true) or if the default value was returned (false).

It’s good programming practice to always use the Found terminal of the Get Item Property VI to check that the intended property name was found on the item.

NI VeriStand – Remove Item Property VI Owning Palette: Item Properties VIs

Removes the Property Name from an item.



Item Ref in is the NI VeriStand reference to the item.
Property Name is an arbitrary case-sensitive name for the property.
error in describes error conditions that occur before this node runs. This input provides standard error in functionality.
Item Ref out is a duplicate of Item Ref in.
Removed indicates if the property was found and removed successfully.
error out contains error information. This output provides standard error out functionality.

 
The Get Item Property and Remove Item Property VIs may be called from any VI in the custom device. There are several other VIs in the NI VeriStand Custom Device LabVIEW palette that operate on custom device properties. The behavior of the VI is what you’d expect from the name of the VI.
	Item Properties » Get Item Description
	Item Properties » Get Item GUID
	Item Properties » Get Property Names List
	Item Properties » Set Item Description
	Item Properties » Set Item GUID
	Device Properties » Get Custom Device Decimation
	Device Properties » Get Custom Device Driver
	Device Properties » Get Custom Device Version
	Device Properties » Set Custom Device Decimation
	Device Properties » Set Custom Device Driver
	Device Properties » Set Custom Device Version
	Device Properties » Specify Custom Device Execution Mode
Custom Device Decimation
You can set decimation for any type of custom device. However, decimation is handled differently for inline and asynchronous devices. We’ll discuss the difference between these devices later in the document.
An inline custom device is not called if its decimation indicates not to. For example, when you decimate an inline custom device by 4, the PCL calls the custom device at every fourth iteration. It does not mean the custom device has four times as long to execute. The inline custom device must execute in short enough time for the entire PCL to complete its iteration including the time to execute the inline custom device. Asynchronous devices have their channel FIFOs read on the N’th iteration of the PCL, where N is the decimation rate of the asynchronous device.
This information will make more sense after you understand the difference between inline and asynchronous custom devices.
Hierarchy
NI VeriStand's System Explorer allows each custom device to present a hierarchal user configuration interface. A hierarchal structure is not required, but it's a convenient way for the developer to organize and present the device logically to the operator.
 
The Pickering 40-295 device that
ships with NI VeriStand has a simple	Top-level item in
hierarchy. This custom device	the Pickering
hierarchy begins with the Pickering	custom device.
40-295 custom device. This is the top-level item in this custom device’s hierarchy.

Within the next echelon are sections for Desired Values and Actual Values. Within each section are the individual channels. If you're familiar with this 3rd party hardware, the hierarchy is an intuitive configuration interface for the Pickering 40-295 resistive module.

There are an arbitrary number of possible hierarchies for most custom devices.

Figure: Hierarchy of the Pickering 40-295 Custom Device

Within the hierarchy, there are two types of objects: sections and channels. We’ve already discussed custom device channels. Sections provide a logical way to group items in the hierarchy. The default section glyph (icon) is a folder, as shown in the Pickering 40-295 custom device. The developer can change the glyph by modifying the custom device XML. A collection of glyphs that install with NI VeriStand 2010 is found in <Application Data>\System Explorer\Glyphs.
All items in a custom device's configuration tree are either channels or sections, regardless of their glyph. You cannot create additional levels of custom device hierarchy from channels. You cannot map sections to other items in NI VeriStand. You cannot exchange data through sections during run-time as you can with channels.
Sections are created with NI VeriStand Custom Device API » Custom Device API VIs » Configuration VIs » NI VeriStand - Add Custom Device Section.
 
NI VeriStand – Add Custom Device Section VI Owning Palette: Configuration

Adds a section with the name Section Name to the device specified by Parent Ref in. If the Section Name you specify already exists for that device, this VI updates only the GUID of that section without affecting any properties or any child items.

 

Highlight? makes the item active in System Explorer.
GUID (Default Section) specifies the GUID of a custom page in the custom device XML file.
Parent Ref in is the NI VeriStand reference to the parent for the new section.
Section Name is the name of the new section. The name is applied to the channel when the VI runs. If the operator changes the name of the section in the System Explorer, the changed name persists.
error in describes error conditions that occur before this node runs. This input provides standard error in
functionality.
Property names is an string array of arbitrary property names assigned to the section.
Property Values is a variant array that cooresponds one-to-one with the property names.
Parent Ref out is a duplicate of the Parent Ref in.
Section Ptr provides the NI VeriStand reference to the new section.
error out contains error information. This output provides standard error out functionality.



The Add Custom Device Section VI may be called from any VI that runs on the host computer. You build-up the custom device hierarchy by using the Parent Reference terminal and the Section Pointer terminal. Parent Reference is the level of the hierarchy that will contain the new section. Section Pointer is the reference to the new section, one level deeper in the custom device hierarchy than the Parent Reference. Now we’ll examine several hierarchies for the AES-201 and discuss the advantages and disadvantages of each.
 
 	 
Figure: Flat Custom Device Hierarchy and Corresponding Initialization VI

The figure above is an example of a flat or single-level hierarchy for the AES-201. All of the channels are under the main section in the configuration tree. While it’s easy to determine how many channels are available, the type of channel is unknown and the function of the channel is implied by the channel name. A flat hierarchy is suited for devices with a small number of channels that all perform the same function. A flat hierarchy is less suited for large channel count devices, or when channels perform different functions. For example, a custom device for a multifunction data acquisition board would be difficult to present in a flat hierarchy.
Notice that the same Device Item Ref in is used to create the SWTrig, ADEnCh<1..8>, and ADDataFromCh<1..8> channels. As a result, all of these channels appear at the same echelon of the hierarchy. In the code above, you should be able to identify the input and output channels. SWTrig and ADEnCh<1..8> are input channels because the custom device sinks data from them. ADDataFromCh<1..8> are output channels because they source data to the rest of NI VeriStand. We’ll be showing clusters as icons in much of the following material.
From an operator's perspective, custom device inputs and outputs may seem backwards. Hardware inputs correspond to custom device outputs. The operator is not required to interact with the custom device source code, only System Explorer. If the developer did a good job, channel direction should make sense to the operator.
 
 	 
Figure: Nested Custom Device Hierarchy and Corresponding Initialization VI

The figure above is an example of a nested hierarchy for the AES-201. The channels have been organized into Hardware Enables and Hardware Inputs sections. This device is well-organized and fairy intuitive. Note how the Section Ptr outputs are used to create channels beneath the corresponding section in the Initialization VI. Also note how the parent reference is used to create the trigger channel at the same level as the two sections in the custom device hierarchy.
You can create an arbitrarily complex hierarchy. You should plan the custom device hierarchy to use the minimum number of sections that make the hierarchy well-organized, intuitive, and user friendly.
Pages
Pages are VIs that System Explorer displays in the configuration pane. The configuration pane is a Subpanel. Subpanels are LabVIEW front panel containers that allow a VI to display the front panel of another VI. See LabVIEW 2010 Help » Fundamentals » Building the Front Panel
» Concepts » Front Panel Controls and Indicators » Subpanel Controls for more information.
An item’s page gets displayed in the Subpanel when the operator clicks on the item in system Explorer’s configuration tree. Pages run on the host computer; they define the appearance and configuration experience of the custom device. The Custom Device Template Tool creates two configuration VIs by default: Initialization and Main. The Initialization VI is a simple VI (it doesn’t get populated into the Subpanel), the Main VI is a page.
When you click on the top-most custom device item in the configuration tree, <Custom Device Name> Main Page.vi goes into System Explorer’s configuration pane’s Subpanel and its block diagram executes.
 


 	 
Figure: Main VI Populated into System Explorer when the Operator Clicks the Top-level
Custom Device Item in the Configuration Tree

If the developer did not assign a custom page to a new section or channel, the default section or channel page is shown when the operator clicks on the item in the configuration tree.
















Figure: The Default Section Page	Figure: The Default Channel Page


The default pages allow the operator to set a description for the section or page. NI VeriStand retains this data in the System Definition (nivssdf) file. You cannot individually modify the block diagram or font panel of the default pages. The Custom Device Template Tool allows the developer to specify extra pages. Extra pages can be used to override the default page for an item. When the developer creates an extra page and associates it with a section or channel, he overrides the default page for that item. You can individually modify the front panel and block diagram of extra pages. The block diagram executes when the operator clicks on the item in the configuration tree.
 
Before we discuss adding extra pages in detail, we must cover a two rules for modifying custom device pages.
	You must not change the size of any page's front panel. The page's front panel is loaded into a Subpanel in the configuration pane. If you change the size of the front panel, it may not fit correctly into the Subpanel and may be unusable.
	You must not change the names or connector pane associations of any terminal generated by the page template or Custom Device Template Tool. NI VeriStand uses these objects to interface with the page. If they are changed, the custom device will not work and will likely prevent the operator from deploying the system definition.
Extra Pages
Extra pages provide a way to customize the appearance and/or behavior of any item in the custom device's hierarchy. Extra pages override the default pages. You should plan an extra page for each item in the custom device you wish to customize differently. For example, if you want to customize the page for each ADDataFromCh channel, but you’ll customize all ADDataFromCh channels the same (say by adding an extra button for the filter), you only need one extra page. NI VeriStand stores state data for each individual item in the custom device hierarchy in the nivssdf file.
The AES-201 may call for five extra pages. One page for each section, one page each for the ADDataFromCh<1..8> and ADEnCh<1..8> channels, and one page for the SWTrig channel. Even if you don’t wind up using the extra pages, it’s better to have extra pages that you don’t need than to need extra pages that you don’t have.
NI VeriStand requires four things in order to override a default page with an extra page in the custom device.
1.	Page
2.	Globally Unique IDentifier (GUID)
3.	XML Declaration
4.	Build Specification
 
Page
A properly formed page VI must exist. If you plan properly, you’ll be able to specify all the extra pages when you run the Custom Device Template Tool. An extra page is created for each element in the Extra Page Names (No Extension) control.

The tool generates the page, GUID, XML Declaration, and includes the page in the build specification. You’ll find the extra page template in Custom Device API.lvlib\Templates\Subpane l Page VI\Page Template.vit.	
















Figure: Extra Page Names Array


If you do not use the Custom Device Template Tool to create extra pages, you must manually add and configure them.

Manually adding extra pages to a custom device after running the Custom Device Template Tool is cumbersome. Avoid this issue by creating a few extra pages beyond what you think will be necessary. Unused extra pages are not executed, but they do consume marginal space on disk.
GUID
When you associate an extra page with a channel or section, you override the default page for that item. This is done by specifying a GUID when the item is created, or by setting the item’s GUID using NI VeriStand Custom Device API » Configuration » Item Properties » Set Item GUID.

Figure: NI VeriStand API to Set an Item’s GUID

The Custom Device Template Tool generates a GUID for each extra page in the Extra Page Names (No Extension) control.
There is a GUID Generator VI in <vi.lib>\NI Veristand\Custom Device Tools\Custom Device Template Tool\Custom Device Template Tool.lvlib:GUID Generator.vi. Before you can run this VI by itself, you must change the Custom Device Template Tool.lvlib\subVIs access scope to public, and set the
 
VI’s Execution Priority to Normal. There is a stand-alone GUID generator VI attached to KnowledgeBase 571B7IYP: Adding a Page to an NI VeriStand Custom Device's Configuration Library after Running the Custom Device Template Tool. There are also a variety of free GUID generators on-line.
XML Declaration
The custom device API associates a channel or section with a GUID. The custom device XML associates the GUID with the page VI. The page and its GUID must be declared in the custom device XML <PAGES> section within a <PAGE> schema. If the developer planned for the extra pages before running the Custom Device Template Tool, the tool makes the appropriate entries in the custom device XML file for each extra page.

<Page>
<Name>
<eng>Extra Page 1</eng>
<loc>Extra Page 1</loc>
</Name>
<GUID>36481013-A447-6517-7D1C-FBB21CAE1E9F</GUID>
<Glyph>
<Type>To Application Data Dir</Type>
<Path>System Explorer\Glyphs\default fpga category.png</Path>
</Glyph>
<Item2Launch>
<Type>To Common Doc Dir</Type>
<Path>Custom Devices\Extra Page Demo\Demo Configuration.llb\Extra Page 1.vi</Path>
</Item2Launch>
</Page>
Custom Device XML Showing the Page Name, GUID, and VI

Build Specification
Extra pages are dynamically called VIs. Since they are not a part of the custom device’s VI hierarchy, they must be explicitly included in the custom device's Build Specification. If the developer planned for the required extra pages before running the Custom Device Template Tool, the tool configures the build specifications to include the extra pages into the initialization library.
If a page must be added to the custom device after the tool has been run, the developer must edit the configuration Build Specification to include the extra page and all its dynamically called dependencies (if any).
